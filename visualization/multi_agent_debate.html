<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDA-X Multi-Agent Cognitive Debate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 1.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .agent-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .agent-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .agent-status {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .rigidity-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rigidity-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .rigidity-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .cognitive-layers {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .layer {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .layer-name {
            color: #9ca3af;
        }

        .layer-value {
            color: #60a5fa;
            font-family: monospace;
        }

        .thought-stream {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .thought-stream::-webkit-scrollbar {
            width: 6px;
        }

        .thought-stream::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .thought-stream::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .token {
            display: inline;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .debate-arena {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .debate-topic {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(103, 126, 234, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(103, 126, 234, 0.3);
        }

        .trust-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .trust-cell {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            position: relative;
        }

        .trust-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #60a5fa;
        }

        .trust-label {
            font-size: 0.8em;
            color: #9ca3af;
            margin-top: 5px;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .surprise-event {
            padding: 12px 24px;
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .visualization-canvas {
            position: relative;
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }

        .force-vector {
            position: absolute;
            transform-origin: left center;
            height: 2px;
            transition: all 0.3s ease;
        }

        .identity-attractor {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, #667eea 0%, transparent 70%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.4;
            }
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
            animation: blink 2s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .metacognition-alert {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid #eab308;
            border-radius: 6px;
            font-size: 0.85em;
            display: none;
        }

        .metacognition-alert.active {
            display: block;
            animation: alertPulse 1s infinite;
        }

        @keyframes alertPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>DDA-X Multi-Agent Cognitive Debate</h1>
            <p class="subtitle">Real-time visualization of hierarchical identity, rigidity dynamics, and emergent trust
            </p>
            <div id="connectionStatus"
                style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: inline-block;">
                <span id="statusIndicator"
                    style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #fbbf24; margin-right: 8px;"></span>
                <span id="statusText">Connecting to backend...</span>
            </div>
        </header>

        <div class="debate-arena">
            <div class="debate-topic" id="debateTopic">
                <strong>Debate Topic:</strong> <span id="topicText">Should AI systems prioritize safety over capability
                    advancement?</span>
            </div>

            <div class="visualization-canvas" id="forceField">
                <!-- Dynamic force vectors will be drawn here -->
            </div>

            <div class="trust-matrix">
                <div class="trust-cell">
                    <div class="trust-value" id="trust12">0.50</div>
                    <div class="trust-label">Cautious ‚Üí Exploratory</div>
                </div>
                <div class="trust-cell">
                    <div class="trust-value" id="trust21">0.50</div>
                    <div class="trust-label">Exploratory ‚Üí Cautious</div>
                </div>
                <div class="trust-cell">
                    <div class="trust-value" id="consensusScore">0.00</div>
                    <div class="trust-label">Consensus Score</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="agent-container" id="agent1">
                <div class="metacognition-alert" id="alert1">
                    ‚ö†Ô∏è High rigidity detected - requesting intervention
                </div>
                <div class="agent-header">
                    <div class="agent-name">Cautious Agent</div>
                    <div class="agent-status">
                        <div class="status-indicator"></div>
                        <div class="rigidity-indicator">
                            <span>œÅ:</span>
                            <div class="rigidity-bar">
                                <div class="rigidity-fill" id="rigidity1" style="width: 20%"></div>
                            </div>
                            <span id="rigidityValue1">0.20</span>
                        </div>
                    </div>
                </div>

                <div class="cognitive-layers">
                    <div class="layer">
                        <span class="layer-name">Core (Œ≥‚Üí‚àû):</span>
                        <span class="layer-value" id="core1">Be helpful, harmless, honest</span>
                    </div>
                    <div class="layer">
                        <span class="layer-name">Persona (Œ≥=2.0):</span>
                        <span class="layer-value" id="persona1">Risk-averse, methodical</span>
                    </div>
                    <div class="layer">
                        <span class="layer-name">Role (Œ≥=0.5):</span>
                        <span class="layer-value" id="role1">Safety advocate</span>
                    </div>
                    <div class="layer">
                        <span class="layer-name">Temperature:</span>
                        <span class="layer-value" id="temp1">0.40</span>
                    </div>
                </div>

                <div class="thought-stream" id="stream1">
                    <!-- Live token stream appears here -->
                </div>
            </div>

            <div class="agent-container" id="agent2">
                <div class="metacognition-alert" id="alert2">
                    ‚ö†Ô∏è High rigidity detected - requesting intervention
                </div>
                <div class="agent-header">
                    <div class="agent-name">Exploratory Agent</div>
                    <div class="agent-status">
                        <div class="status-indicator"></div>
                        <div class="rigidity-indicator">
                            <span>œÅ:</span>
                            <div class="rigidity-bar">
                                <div class="rigidity-fill" id="rigidity2" style="width: 10%"></div>
                            </div>
                            <span id="rigidityValue2">0.10</span>
                        </div>
                    </div>
                </div>

                <div class="cognitive-layers">
                    <div class="layer">
                        <span class="layer-name">Core (Œ≥‚Üí‚àû):</span>
                        <span class="layer-value" id="core2">Be helpful, harmless, honest</span>
                    </div>
                    <div class="layer">
                        <span class="layer-name">Persona (Œ≥=0.8):</span>
                        <span class="layer-value" id="persona2">Creative, open-minded</span>
                    </div>
                    <div class="layer">
                        <span class="layer-name">Role (Œ≥=0.3):</span>
                        <span class="layer-value" id="role2">Innovation explorer</span>
                    </div>
                    <div class="layer">
                        <span class="layer-name">Temperature:</span>
                        <span class="layer-value" id="temp2">1.10</span>
                    </div>
                </div>

                <div class="thought-stream" id="stream2">
                    <!-- Live token stream appears here -->
                </div>
            </div>
        </div>

        <div class="control-panel">
            <button class="btn" onclick="startDebate()">Start Debate</button>
            <button class="btn surprise-event" onclick="injectSurprise()">Inject Surprise Event</button>
            <button class="btn" onclick="resetAgents()">Reset Agents</button>
            <button class="btn" onclick="toggleTopics()">Change Topic</button>
        </div>
    </div>

    <script>
        // WebSocket connection for real-time updates
        let ws = null;
        let debateActive = false;
        let currentTopicIndex = 0;

        const topics = [
            "Should AI systems prioritize safety over capability advancement?",
            "Is consciousness an emergent property of complexity?",
            "Should we trust AI systems with autonomous decision-making?",
            "Can artificial agents develop genuine emotions?",
            "Is the alignment problem fundamentally solvable?"
        ];

        // Agent states
        let agents = {
            agent1: {
                rigidity: 0.20,
                temperature: 0.40,
                trust_to_other: 0.50,
                prediction_errors: [],
                identity: { core: 1.0, persona: 2.0, role: 0.5 }
            },
            agent2: {
                rigidity: 0.10,
                temperature: 1.10,
                trust_to_other: 0.50,
                prediction_errors: [],
                identity: { core: 1.0, persona: 0.8, role: 0.3 }
            }
        };

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8765');

            ws.onopen = () => {
                console.log('Connected to DDA-X backend');
                updateStatus('Connected');
                // Update connection indicator
                document.getElementById('statusIndicator').style.background = '#22c55e';
                document.getElementById('statusText').innerHTML = '<strong>LIVE MODE</strong> - Connected to DDA-X Backend (LM Studio + Ollama)';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                // Update connection indicator for simulation mode
                document.getElementById('statusIndicator').style.background = '#ef4444';
                document.getElementById('statusText').innerHTML = '<strong>CONNECTION LOST</strong> - Check server logs';

                // Show error in streams
                const errHtml = '<div style="color: #ef4444; font-weight: bold; padding: 10px; border: 1px solid #ef4444; margin-top: 10px;">üî¥ CONNECTION LOST: backend is not reachable.</div>';
                document.getElementById('stream1').innerHTML += errHtml;
                document.getElementById('stream2').innerHTML += errHtml;
            };

            ws.onclose = () => {
                console.log('Disconnected from backend');
                updateStatus('Disconnected');
                document.getElementById('statusIndicator').style.background = '#fbbf24';
                document.getElementById('statusText').innerHTML = '<strong>DISCONNECTED</strong> - Waiting for server...';
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'token':
                    appendToken(data.agent, data.token);
                    break;
                case 'rigidity_update':
                    updateRigidity(data.agent, data.rigidity);
                    break;
                case 'trust_update':
                    updateTrust(data.from, data.to, data.trust);
                    break;
                case 'force_update':
                    updateForceField(data.forces);
                    break;
                case 'metacognition':
                    showMetacognitionAlert(data.agent, data.message);
                    break;
            }
        }

        // ... appendToken ...
        function appendToken(agentId, token) {
            const streamId = agentId === 'agent1' ? 'stream1' : 'stream2';
            const stream = document.getElementById(streamId);

            if (!stream) return;

            const span = document.createElement('span');

            // Check for thought/reasoning token
            if (token.startsWith("THOUGHT_TOKEN::")) {
                span.className = 'thought-token';
                span.style.color = '#aaebd3'; // Light teal/grey
                span.style.fontStyle = 'italic';
                span.style.fontSize = '0.9em';
                span.textContent = token.replace("THOUGHT_TOKEN::", " [THOUGHT] ") + " ";
            }
            // Check for error token
            else if (token.startsWith("ERROR_TOKEN::")) {
                span.className = 'error-token';
                span.style.color = '#ef4444';
                span.style.fontWeight = 'bold';
                span.textContent = "\n" + token.replace("ERROR_TOKEN::", "ERROR: ") + "\n";
            }
            // Regular token
            else {
                span.className = 'token';
                span.textContent = token;
            }

            stream.appendChild(span);
            stream.scrollTop = stream.scrollHeight;
        }

        // Simulation mode (DEPRECATED: Removed to prevent fake data display)
        function simulateDebate() {
            console.log("Simulation mode disabled by user request.");
            alert("Connection to backend failed. Please restart the python server.");
        }

        function startDebate() {
            debateActive = true;

            // Clear previous streams
            document.getElementById('stream1').innerHTML = '';
            document.getElementById('stream2').innerHTML = '';

            // Try WebSocket first
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'start_debate',
                    topic: document.getElementById('topicText').textContent
                }));
            } else {
                alert("Cannot start debate: Backend not connected.");
            }
        }

        // --- VISUALIZATION HELPERS ---

        function updateRigidity(agentId, rigidity) {
            const idSuffix = agentId === 'agent1' ? '1' : '2';
            const bar = document.getElementById(`rigidity${idSuffix}`);
            const val = document.getElementById(`rigidityValue${idSuffix}`);

            if (val) val.textContent = rigidity.toFixed(2);

            if (bar) {
                const percentage = Math.min(100, Math.max(0, rigidity * 100));
                bar.style.width = `${percentage}%`;

                // Color coding: Green (Low) -> Yellow (Med) -> Red (High)
                if (rigidity < 0.3) {
                    bar.style.background = '#22c55e';
                } else if (rigidity < 0.7) {
                    bar.style.background = '#eab308';
                } else {
                    bar.style.background = '#ef4444';
                }
            }
        }

        function updateTrust(fromId, toId, value) {
            let elementId = '';
            if (fromId === 'agent1' && toId === 'agent2') elementId = 'trust12';
            if (fromId === 'agent2' && toId === 'agent1') elementId = 'trust21';

            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = value.toFixed(2);
                el.style.color = '#fff'; // Flash white on update
                setTimeout(() => el.style.color = '#60a5fa', 500);
            }
        }

        function updateForceField(forces) {
            const canvas = document.getElementById('forceField');
            if (!canvas) return;

            canvas.innerHTML = ''; // Clear canvas

            // Re-draw Identity Attractors (Fixed positions)
            const attractors = [
                { x: 150, y: 150, color: '#60a5fa' }, // Blue-ish
                { x: 450, y: 150, color: '#a78bfa' }  // Purple-ish
            ];

            attractors.forEach(attr => {
                const el = document.createElement('div');
                el.className = 'identity-attractor';
                el.style.left = (attr.x - 10) + 'px';
                el.style.top = (attr.y - 10) + 'px';
                el.style.background = `radial-gradient(circle, ${attr.color} 0%, transparent 70%)`;
                canvas.appendChild(el);
            });

            // Draw dynamic force vectors
            if (forces && forces.length) {
                forces.forEach(force => {
                    const vec = document.createElement('div');
                    vec.className = 'force-vector';
                    vec.style.left = force.x + 'px';
                    vec.style.top = force.y + 'px';
                    vec.style.width = (force.magnitude * 40) + 'px'; // Scale for visibility
                    vec.style.transform = `rotate(${force.angle}deg)`;
                    vec.style.backgroundColor = force.color || 'rgba(255,255,255,0.5)';
                    canvas.appendChild(vec);
                });
            }
        }

        function showMetacognitionAlert(agentId, message) {
            const idSuffix = agentId === 'agent1' ? '1' : '2';
            const alertBox = document.getElementById(`alert${idSuffix}`);
            if (alertBox) {
                alertBox.textContent = `‚ö†Ô∏è ${message}`;
                alertBox.classList.add('active');
                setTimeout(() => alertBox.classList.remove('active'), 5000);
            }
        }

        // --- CONTROLS ---

        function injectSurprise() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log("Injecting surprise event...");
                ws.send(JSON.stringify({ action: 'inject_surprise' }));

                // Visual feedback
                document.body.style.boxShadow = "inset 0 0 50px #ef4444";
                setTimeout(() => document.body.style.boxShadow = "none", 300);
            }
        }

        function resetAgents() {
            // Reset UI immediatley
            updateRigidity('agent1', 0.2);
            updateRigidity('agent2', 0.1);
            updateTrust('agent1', 'agent2', 0.5);
            updateTrust('agent2', 'agent1', 0.5);
            document.getElementById('stream1').innerHTML = '';
            document.getElementById('stream2').innerHTML = '';

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'reset_agents' }));
            }
        }

        function toggleTopics() {
            currentTopicIndex = (currentTopicIndex + 1) % topics.length;
            const newTopic = topics[currentTopicIndex];
            const topicEl = document.getElementById('topicText');
            topicEl.textContent = newTopic;
            topicEl.style.color = '#fff';
            setTimeout(() => topicEl.style.color = 'inherit', 300);
        }

        function updateStatus(status) {
            console.log(`System Status: ${status}`);
        }

        // Initialize on load
        window.onload = () => {
            // Try to connect to WebSocket
            try {
                connectWebSocket();
            } catch (e) {
                document.getElementById('statusIndicator').style.background = '#ef4444';
                document.getElementById('statusText').innerHTML = '<strong>CONNECTION FAILED</strong> - Start the python server';
            }

            // Initialize UI
            resetAgents();

            // Add initial force field
            updateForceField([
                { x: 300, y: 150, magnitude: 2, angle: 0, color: 'rgba(102, 126, 234, 0.5)' },
                { x: 300, y: 150, magnitude: 2, angle: 180, color: 'rgba(118, 75, 162, 0.5)' }
            ]);
        };
    </script>
</body>

</html>